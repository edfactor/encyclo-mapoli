# ------------------------------------------------------------------------
# BitBucket Pipeline
# ------------------------------------------------------------------------
# Application Name:
#   - SMART Profit Sharing
# ------------------------------------------------------------------------

definitions:
  steps:
    build-and-test-backend: &build-and-test-backend
      name: Build and Test Backend API
      runs-on:
        - windows
        - self.hosted
      script:
        # Set environment variables
        - $env:NUGET_ORG = "https://api.nuget.org/v3/index.json"
        - $env:TEST_PROJECT_NAME = "Demoulas.ProfitSharing.UnitTests"
        - $env:REPORTS_PATH = "../../../../test-reports/build_${BITBUCKET_BUILD_NUMBER}"
        
        # Ensure the REPORTS_PATH directory exists
        - mkdir -Force -Path $env:REPORTS_PATH

        # Check if .NET 9 SDK is installed
        - echo "Checking installed .NET SDK versions..."
        - $dotnetSdkInstalled = dotnet --list-sdks | Select-String "^9\.(\d+)\.(\d+)"
        - if ($dotnetSdkInstalled) {
              $isSdkValid = $false;
              foreach ($sdk in $dotnetSdkInstalled) {
                if ($sdk -match "^9\.(\d+)\.(\d+)") {
                  $minor = [int]$matches[1];
                  $patch = [int]$matches[2];
                  if ($minor -gt 0 -or $patch -ge 304) {
                    $isSdkValid = $true;
                    break;
                  }
                }
              }
              if ($isSdkValid) {
                Write-Output ".NET SDK 9.0.304 or higher is installed.";
              } else {
                Write-Output ".NET SDK 9.0.304 or higher is NOT installed.";
                Invoke-WebRequest -Uri "https://builds.dotnet.microsoft.com/dotnet/Sdk/9.0.304/dotnet-sdk-9.0.304-win-x64.exe" -OutFile "$env:TEMP\dotnet-sdk-9.0.304-win-x64.exe";
                Start-Process -FilePath "$env:TEMP\dotnet-sdk-9.0.304-win-x64.exe" -ArgumentList "/quiet", "/norestart" -Wait;
              }
            } else {
              Write-Output "No .NET 9.x SDK installed.";
            }        
          

        # Run tests and generate JUnit reports
        - dotnet test src/services/tests/Demoulas.ProfitSharing.UnitTests/{$env:TEST_PROJECT_NAME}.csproj --configuration Release -p:RestoreAdditionalProjectSources=$env:NUGET_ORG --test-adapter-path:. --logger:"junit;LogFilePath={$env:REPORTS_PATH}/junit.xml"

      artifacts:
        - test-reports/**
    
    test-frontend: &test-frontend
      name: Build and Test Frontend UI
      runs-on:
        - windows
        - self.hosted
        - volta
      artifacts:
        - dist\**
      script:
        - $env:NPM = "npm"
        - ${env:ENV} = "qa"
        - cd .\src\UI
        - |
            @"
            registry=https://demoulas.jfrog.io/artifactory/api/npm/demoulas-npm-virt/
            //demoulas.jfrog.io/artifactory/api/npm/demoulas-npm-virt/:_authToken=$env:JFROG_WORKSPACE_VARIABLE
            "@ | Out-File -FilePath .npmrc -Encoding ASCII
        - if (Test-Path -Path "node_modules") { Remove-Item -Recurse -Force "node_modules" }        
        
        - dotnet tool update --global Demoulas.Common.Build.Cli
        - dotnet tool update --global --all
        
        - Demoulas.Common.Build.Cli --buildid ${env:BITBUCKET_BUILD_NUMBER} --Branch ${env:BITBUCKET_BRANCH} --CommitHash ${env:BITBUCKET_COMMIT}
        - Copy-Item -Path ".buildinfo.json" -Destination ".\public" -Force
        
        - npm ci;
        - npm run build:${env:ENV}
   
    
    create-api-artifacts: &create-api-artifacts
      name: Create API Artifacts
      runs-on:
        - windows
        - self.hosted
      artifacts:
        - dist\**
      script:
        - dotnet tool update --global Demoulas.Common.Build.Cli
        - dotnet tool update --global --all
        - Write-Host ${env:BITBUCKET_BUILD_NUMBER}
        - Write-Host ${env:BITBUCKET_BRANCH}
        - Write-Host ${env:BITBUCKET_COMMIT}
        - Write-Host $(Get-Location)
        - Write-Host $(Get-ChildItem)
        - New-Item -ItemType Directory -Path "dist"

        - dotnet publish .\src\Services\src\Demoulas.ProfitSharing.Api -c Release -p:PublishProfile=FolderProfile -o .\publishOutput
        
        - Demoulas.Common.Build.Cli --buildid ${env:BITBUCKET_BUILD_NUMBER} --Branch ${env:BITBUCKET_BRANCH} --CommitHash ${env:BITBUCKET_COMMIT}
        - Copy-Item -Path ".buildinfo.json" -Destination ".\publishOutput\"
        
        - Compress-Archive -Path .\publishOutput\* -DestinationPath .\dist\Demoulas.ProfitSharing.Api.zip -Force

    create-service-artifacts: &create-service-artifacts
      name: Create Background Service Artifacts
      runs-on:
        - windows
        - self.hosted
      artifacts:
        - dist\**
      script:
        - $env:NUGET_ORG = "https://api.nuget.org/v3/index.json"
        - Write-Host $(Get-Location)
        - Write-Host $(Get-ChildItem)
        - New-Item -ItemType Directory -Path "dist"
        
        - dotnet tool update --global Demoulas.Common.Build.Cli
        - dotnet tool update --global --all

        - dotnet publish .\src\Services\src\Demoulas.ProfitSharing.EmployeeFull.Sync -c Release -p:RestoreAdditionalProjectSources=$env:NUGET_ORG -p:PublishProfile=FolderProfile -o .\publishOutput
        - Compress-Archive -Path .\publishOutput\* -DestinationPath .\dist\Demoulas.ProfitSharing.EmployeeFull.Sync.zip -Force

        - dotnet publish .\src\Services\src\Demoulas.ProfitSharing.EmployeeDelta.Sync -c Release -p:RestoreAdditionalProjectSources=$env:NUGET_ORG -p:PublishProfile=FolderProfile -o .\publishOutput
        - Compress-Archive -Path .\publishOutput\* -DestinationPath .\dist\Demoulas.ProfitSharing.EmployeeDelta.Sync.zip -Force

        - dotnet publish .\src\Services\src\Demoulas.ProfitSharing.EmployeePayroll.Sync -c Release -p:RestoreAdditionalProjectSources=$env:NUGET_ORG -p:PublishProfile=FolderProfile -o .\publishOutput
        - Compress-Archive -Path .\publishOutput\* -DestinationPath .\dist\Demoulas.ProfitSharing.EmployeePayroll.Sync.zip -Force

    create-frontend-artifact-qa: &create-frontend-artifact-qa
      name: Create FrontEnd Artifacts (QA)     
      runs-on:
        - windows
        - self.hosted
        - volta
      artifacts:
        - dist\**
      script:
        - $env:NPM = "npm"
        - ${env:ENV} = "qa"
        - cd .\src\UI
        - |
            @"
            registry=https://demoulas.jfrog.io/artifactory/api/npm/demoulas-npm-virt/
            //demoulas.jfrog.io/artifactory/api/npm/demoulas-npm-virt/:_authToken=$env:JFROG_WORKSPACE_VARIABLE
            "@ | Out-File -FilePath .npmrc -Encoding ASCII
        - if (Test-Path -Path "node_modules") { Remove-Item -Recurse -Force "node_modules" }        
        
        - dotnet tool update --global Demoulas.Common.Build.Cli
        - dotnet tool update --global --all
        
        - Demoulas.Common.Build.Cli --buildid ${env:BITBUCKET_BUILD_NUMBER} --Branch ${env:BITBUCKET_BRANCH} --CommitHash ${env:BITBUCKET_COMMIT}
        - Copy-Item -Path ".buildinfo.json" -Destination ".\public" -Force
        
        - npm ci;
        - npm run build:${env:ENV}

        - Copy-Item -Path ".\src\web.config" -Destination "..\..\src\UI\build"
        - New-Item -Path "..\..\dist" -ItemType Directory
        - Compress-Archive -Path "..\..\src\UI\build\*" -DestinationPath "..\..\dist\Demoulas.ProfitSharing.UI.${env:ENV}.zip" -Force        

    create-frontend-artifact-uat: &create-frontend-artifact-uat
      name: Create FrontEnd Artifacts (UAT)     
      runs-on:
        - windows
        - self.hosted
        - volta
      artifacts:
        - dist\**
      script:
        # Set environment variables
        - ${env:ENV} = "uat"

        # Navigate to the UI source directory
        - cd .\src\UI

        # Create and configure .npmrc file
        - |
            @"
            registry=https://demoulas.jfrog.io/artifactory/api/npm/demoulas-npm-virt/
            //demoulas.jfrog.io/artifactory/api/npm/demoulas-npm-virt/:_authToken=$env:JFROG_WORKSPACE_VARIABLE
            "@ | Out-File -FilePath .npmrc -Encoding ASCII

        # Clean node_modules and package-lock.json to resolve npm optional dependency bug
        - if (Test-Path -Path "node_modules") { Remove-Item -Recurse -Force "node_modules" }

        # Install dependencies
        - npm ci;

        # Generate and copy buildInfo.json
        - dotnet tool update --global Demoulas.Common.Build.Cli
        - Demoulas.Common.Build.Cli --buildid ${env:BITBUCKET_BUILD_NUMBER} --Branch ${env:BITBUCKET_BRANCH} --CommitHash ${env:BITBUCKET_COMMIT}
        - Copy-Item -Path ".buildinfo.json" -Destination ".\public" -Force

        # Run the build process for the specified environment
        - npm run build:${env:ENV}

        # Copy the web.config file to the build directory
        - Copy-Item -Path ".\src\web.config" -Destination "..\..\src\UI\build" -Force

        # Ensure the dist directory exists before compressing
        - if (!(Test-Path -Path "..\..\dist")) {
            New-Item -Path "..\..\dist" -ItemType Directory
            }

        # Compress the build output into a zip file in the dist folder
        - Compress-Archive -Path "..\..\src\UI\build\*" -DestinationPath "..\..\dist\Demoulas.ProfitSharing.UI.${env:ENV}.zip" -Force

    create-frontend-artifact-prod: &create-frontend-artifact-prod
      name: Create FrontEnd Artifacts (PROD)
      runs-on:
        - windows
        - self.hosted
        - volta
      artifacts:
        - dist\**
      script:
        - $env:NPM = "npm"
        - ${env:ENV} = "prod"
        - if (!(Test-Path -Path ".\src\UI")) { Write-Error "UI source directory not found. Exiting."; exit 1 }
        - cd .\src\UI
        # Clean node_modules and package-lock.json to resolve npm optional dependency bug
        - if (Test-Path -Path "node_modules") { Remove-Item -Recurse -Force "node_modules" }
        - ${env:NPM} ci;
        
        # Generate and copy buildInfo.json
        - dotnet tool update --global Demoulas.Common.Build.Cli
        - Demoulas.Common.Build.Cli --buildid ${env:BITBUCKET_BUILD_NUMBER} --Branch ${env:BITBUCKET_BRANCH} --CommitHash ${env:BITBUCKET_COMMIT}
        - Copy-Item -Path ".buildinfo.json" -Destination ".\public" -Force
        
        - ${env:NPM} run build:${env:ENV}
        - Compress-Archive -Path "..\..\src\UI\build\*" -DestinationPath "..\..\dist\Demoulas.ProfitSharing.UI.$env:ENV.zip" -Force
    
    upgrade-database: &upgrade-database
      name: Upgrade Database
      runs-on:
        - windows
        - self.hosted
      artifacts:
        - dist\**
      script:
        - |
          dotnet build .\src\services\src\Demoulas.ProfitSharing.Data.Cli\Demoulas.ProfitSharing.Data.Cli.csproj -o .\output
          if ($LASTEXITCODE -ne 0) { Write-Error "Database project build failed. Exiting."; exit 1 }

          $environment = $env:Environment
          $action = $env:Action
          $sourceSchema = $env:SourceSchema
          $currentYear = $env:CurrentYear

          if (-not $environment) { $environment = "QA" }
          if (-not $action) { $action = "upgrade-db" }
          if (-not $sourceSchema) { $sourceSchema = "PROFITSHARE" }
          if (-not $currentYear) { $currentYear = "2023" }

          if ($environment -eq "QA") {
            $env:ConnectionStrings:ProfitSharing = $env:ConnectionStrings_ProfitSharing_QA            
          }

          if ($environment -eq "UAT") {
            $env:ConnectionStrings:ProfitSharing = $env:ConnectionStrings_ProfitSharing_UAT            
          }

          if (-not $sourceSchema) {
            Write-Error "Source schema is undefined. Exiting."; exit 1
          }

          Write-Host "Running database upgrade with action: $action"
          Write-Host "Target environment: $environment"
          Write-Host "Source schema: $sourceSchema"
          Write-Host "Current directory: $(Get-Location)"

          .\output\Demoulas.ProfitSharing.Data.Cli $action --connection-name ProfitSharing --output-file ".\dist\migration.sql" --sql-file ".\src\database\ready_import\SQL copy all from ready to smart ps.sql" --source-schema $sourceSchema
          if ($LASTEXITCODE -ne 0) { Write-Error "Database upgrade failed. Exiting"; exit 1 }

          # Determine which navigation file to use based on action or environment
          $navigationFile = ".\src\database\ready_import\Navigations\add-navigation-data.sql"
          if ($action -eq "import-uat-navigation" -or $environment -eq "UAT") {
            $navigationFile = ".\src\database\ready_import\Navigations\add-uat-navigation-data.sql"
            Write-Host "Using UAT navigation data"
          }

          .\output\Demoulas.ProfitSharing.Data.Cli import-from-navigation  --connection-name ProfitSharing --output-file ".\dist\navigations.sql" --sql-file $navigationFile --source-schema $sourceSchema
          if ($LASTEXITCODE -ne 0) { Write-Error "Database upgrade failed. Exiting"; exit 1 }

          if ($action -eq "validate-import") {
            .\output\Demoulas.ProfitSharing.Data.Cli validate-import --connection-name ProfitSharing --sql-file ".\src\database\ready_import\Import Validations.sql" --source-schema $sourceSchema --current-year $currentYear
            if ($LASTEXITCODE -ne 0) { Write-Error "Database import validation failed. Exiting"; exit 1 }
          }
          

    uat-drop-recreate-db: &uat-drop-recreate-db
      name: UAT Drop & Recreate DB
      runs-on:
        - windows
        - self.hosted
      script:
        - |
          $env:Environment = "UAT"
          $env:Action = "drop-recreate-db"
          $env:SourceSchema = "PROFITSHARE_STAGING"
          if ($env:Environment -eq "UAT") { $env:ConnectionStrings:ProfitSharing = $env:ConnectionStrings_ProfitSharing_UAT }
          Write-Host "Dropping & recreating UAT database (schema: $env:SourceSchema)"
          if (!(Test-Path .\dbcli\Demoulas.ProfitSharing.Data.Cli*)) { Write-Error "DB CLI artifact not found. Ensure 'Build DB CLI (artifact)' step ran."; exit 1 }
          .\dbcli\Demoulas.ProfitSharing.Data.Cli $env:Action --connection-name ProfitSharing --source-schema $env:SourceSchema
          if ($LASTEXITCODE -ne 0) { Write-Error "Drop/Recreate failed."; exit 1 }
          Write-Host "Drop & recreate completed."

    uat-import-from-ready: &uat-import-from-ready
      name: UAT Import From READY
      runs-on:
        - windows
        - self.hosted
      script:
        - |
          $env:Environment = "UAT"
          $env:Action = "import-from-ready"
          $env:SourceSchema = "PROFITSHARE_STAGING"
          if ($env:Environment -eq "UAT") { $env:ConnectionStrings:ProfitSharing = $env:ConnectionStrings_ProfitSharing_UAT }
          Write-Host "Importing data from READY into UAT schema: $env:SourceSchema"
          if (!(Test-Path .\dbcli\Demoulas.ProfitSharing.Data.Cli*)) { Write-Error "DB CLI artifact not found. Ensure 'Build DB CLI (artifact)' step ran."; exit 1 }
          .\dbcli\Demoulas.ProfitSharing.Data.Cli $env:Action --connection-name ProfitSharing --sql-file ".\src\database\ready_import\SQL copy all from ready to smart ps.sql" --source-schema $env:SourceSchema
          if ($LASTEXITCODE -ne 0) { Write-Error "Import from READY failed."; exit 1 }
          Write-Host "Import from READY completed."

    uat-import-uat-navigation: &uat-import-uat-navigation
      name: UAT Import Navigation Data
      runs-on:
        - windows
        - self.hosted
      script:
        - |
          $env:Environment = "UAT"
          $env:SourceSchema = "PROFITSHARE_STAGING"
          if ($env:Environment -eq "UAT") { $env:ConnectionStrings:ProfitSharing = $env:ConnectionStrings_ProfitSharing_UAT }
          $navigationFile = ".\src\database\ready_import\Navigations\add-uat-navigation-data.sql"
          Write-Host "Importing UAT navigation data using $navigationFile"
          if (!(Test-Path .\dbcli\Demoulas.ProfitSharing.Data.Cli*)) { Write-Error "DB CLI artifact not found. Ensure 'Build DB CLI (artifact)' step ran."; exit 1 }
          .\dbcli\Demoulas.ProfitSharing.Data.Cli import-from-navigation --connection-name ProfitSharing --sql-file $navigationFile --source-schema $env:SourceSchema
          if ($LASTEXITCODE -ne 0) { Write-Error "Navigation import failed."; exit 1 }
          Write-Host "Navigation import completed."

    uat-validate-import: &uat-validate-import
      name: UAT Validate Import
      runs-on:
        - windows
        - self.hosted
      script:
        - |
          $env:Environment = "UAT"
          $env:SourceSchema = "PROFITSHARE_STAGING"
          $currentYear = (Get-Date).Year

          dotnet build .\src\services\src\Demoulas.ProfitSharing.Data.Cli\Demoulas.ProfitSharing.Data.Cli.csproj -o .\output
          if ($LASTEXITCODE -ne 0) { Write-Error "Database project build failed. Exiting."; exit 1 }

          if ($env:Environment -eq "UAT") { $env:ConnectionStrings:ProfitSharing = $env:ConnectionStrings_ProfitSharing_UAT }

          Write-Host "Validating UAT import for schema $env:SourceSchema and year $currentYear"
          .\output\Demoulas.ProfitSharing.Data.Cli validate-import --connection-name ProfitSharing --sql-file ".\src\database\ready_import\Import Validations.sql" --source-schema $env:SourceSchema --current-year $currentYear
          if ($LASTEXITCODE -ne 0) { Write-Error "Import validation failed."; exit 1 }
          Write-Host "Import validation completed."

    db-cli-build-artifact: &db-cli-build-artifact
      name: Build DB CLI (artifact)
      runs-on:
        - windows
        - self.hosted
      artifacts:
        - dbcli/**
      script:
        - |
          dotnet build .\src\services\src\Demoulas.ProfitSharing.Data.Cli\Demoulas.ProfitSharing.Data.Cli.csproj -o .\dbcli
          if ($LASTEXITCODE -ne 0) { Write-Error "Database CLI build failed. Exiting."; exit 1 }
          Write-Host "DB CLI built to .\\dbcli"

    audit-backend: &audit-backend
      name: "Check Backend API for vulnerabilities"
      runs-on:
        - windows
        - self.hosted
      script:
        - $env:SolutionDir = ".\src\services"        
        - echo "Checking dotnet vulnerabilities"
        - cd $env:SolutionDir

        - dotnet --info
        - dotnet nuget list source
        - dotnet workload update --source https://api.nuget.org/v3/index.json
        - dotnet workload install aspire --source https://api.nuget.org/v3/index.json
        - dotnet restore Demoulas.ProfitSharing.slnx -p:RestoreAdditionalProjectSources=https://api.nuget.org/v3/index.json


        - |
          $output = dotnet list Demoulas.ProfitSharing.slnx package --vulnerable --include-transitive --source https://api.nuget.org/v3/index.json
          if ($output -match "has the following vulnerable packages") {
            Write-Host "Vulnerabilities found!"
            $output | Out-String | Write-Host
            exit 1
          } else {
            Write-Host "No vulnerabilities found."
            exit 0
          }        


    audit-frontend: &audit-frontend
      name: "Check frontend for vulnerabilities"
      runs-on:
        - windows
        - self.hosted
        - volta
      script:
      # Set the following variable to your react project directory that houses your package.json file
        - $env:ReactDir = ".\src\UI"
        - echo "Checking npm vulnerabilities"
        - cd $env:ReactDir
        - npm audit --audit-level=moderate --production
    
    secret-scan: &secret-scan
      name: "Secret scan (Gitleaks)"
      image: zricethezav/gitleaks:latest
      artifacts:
        - reports/**
      script:
        - mkdir -p reports
        - gitleaks detect --source . --config gitleaks.toml --redact --no-banner --report-format json --report-path reports/gitleaks.json --exit-code 0
              - echo "Gitleaks findings (redacted JSON):"
              - head -c 200000 reports/gitleaks.json || true
              - |
                if [ -s reports/gitleaks.json ] && [ "$(wc -c < reports/gitleaks.json)" -gt 2 ]; then
                  echo "Leaks found. Failing the build.";
                  exit 1;
                else
                  echo "No leaks found.";
                fi
    run-playwright-tests: &run-playwright-tests
      name: "Run Playwright E2E Tests (QA)"
      runs-on:
        - windows
        - self.hosted
        - volta
      artifacts:
        - ui/playwright-report/**
        - ui/test-results/**
        - src/UI/playwright-report/**
        - src/UI/test-results/**
        - playwright-artifacts/**
      script:
        # Locate Playwright project directory (support both root 'ui' and 'src/UI')
        - |
          $candidateDirs = @('ui', 'src/UI', 'src/ui')
          $playwrightDir = $null
          foreach ($d in $candidateDirs) {
            if (Test-Path $d) { $playwrightDir = $d; break }
          }
          if (-not $playwrightDir) {
            Write-Error "Could not locate Playwright project directory. Checked: $($candidateDirs -join ', ')"; exit 1
          }
          Write-Host "Using Playwright directory: $playwrightDir"
          Set-Location $playwrightDir
        # Write QA environment variables from secured Bitbucket variable QA_Playwright into .env (multi-line expected)
        - if (-not $env:QA_Playwright) { Write-Error "QA_Playwright variable not set in Bitbucket variables"; exit 1 }
        - Set-Content -Path ./.env -Value "### Generated from Bitbucket variable QA_Playwright (QA) ###"
        - $env:QA_Playwright | Out-File -FilePath ./.env -Append -Encoding UTF8
        - Write-Host "Created .env file (preview):"; Get-Content ./.env | Select-Object -First 20 | ForEach-Object { Write-Host "  $_" }
        # Install dependencies & browsers
        - if (Test-Path -Path "node_modules") { Write-Host "Removing existing node_modules to ensure clean install"; Remove-Item -Recurse -Force node_modules }
        - npm ci
        - npx playwright install --with-deps || npx playwright install
        # Run tests with junit + html reporters (adjust if package.json already configures reporters)
        - mkdir -Force test-results | Out-Null
        - npx playwright test --reporter="list,junit" --config=playwright.config.ts
        # Copy artifacts to a stable root-level directory for collection regardless of working dir
        - |
          $root = Resolve-Path '..'
          $artifactRoot = Join-Path $root 'playwright-artifacts'
          if (!(Test-Path $artifactRoot)) { New-Item -ItemType Directory -Path $artifactRoot | Out-Null }
          if (Test-Path 'playwright-report') { Copy-Item -Recurse -Force 'playwright-report' (Join-Path $artifactRoot 'playwright-report') }
          if (Test-Path 'test-results') { Copy-Item -Recurse -Force 'test-results' (Join-Path $artifactRoot 'test-results') }
        # Summarize results
        - if (Test-Path ./playwright-report) { Write-Host "Playwright HTML report generated in ./playwright-report" }
        - if (Test-Path ./test-results) { Write-Host "JUnit results in ./test-results"; Get-ChildItem ./test-results | ForEach-Object { Write-Host $_.FullName } }
        # Exit with test status
        - if ($LASTEXITCODE -ne 0) { Write-Error "Playwright tests failed."; exit 1 } else { Write-Host "Playwright tests passed." }
          

pipelines:
  branches:
    release:
      - parallel:
          - step: *build-and-test-backend
          - step: *audit-frontend
          - step: *audit-backend
      - parallel:
          - step: *create-api-artifacts
          - step: *create-service-artifacts
          - step: *create-frontend-artifact-qa
          - step: *db-cli-build-artifact
      - step:
          name: "Application Deployment"
          runs-on:
            - windows
            - self.hosted
          deployment: QA
          trigger: "manual"
          script:
            - ${env:ENV} = "QA"
            - $env:API_SERVER_QA = "appt23d"

            - pwsh -File ./scripts/credsettings.ps1 `
              -Environment ${env:ENV} `
              -FilePath './src/services/configuration/credsettings.json' `
              -OutputPath './src/services/configuration/credsettings.qa.json' `
              -RemoteServer $env:API_SERVER_QA `
              -RemotePath 'C:/NextGenApplications/ps/EmployeeDelta'

            - pwsh -File ./scripts/credsettings.ps1 `
              -Environment ${env:ENV} `
              -FilePath './src/services/configuration/credsettings.json' `
              -OutputPath './src/services/configuration/credsettings.qa.json' `
              -RemoteServer $env:API_SERVER_QA `
              -RemotePath 'C:/NextGenApplications/ps/EmployeeFull'

            - pwsh -File ./scripts/credsettings.ps1 `
              -Environment ${env:ENV} `
              -FilePath './src/services/configuration/credsettings.json' `
              -OutputPath './src/services/configuration/credsettings.qa.json' `
              -RemoteServer $env:API_SERVER_QA `
              -RemotePath 'C:/NextGenApplications/ps/Payroll'

            - pwsh -File ./scripts/credsettings.ps1 `
              -Environment ${env:ENV} `
              -FilePath './src/services/configuration/credsettings.json' `
              -OutputPath './src/services/configuration/credsettings.qa.json' `
              -RemoteServer $env:API_SERVER_QA `
              -RemotePath 'C:/inetpub/wwwroot/api'

            - echo "Deploying web application..."
            - $env:API_ARTIFACT_NAME = "Demoulas.ProfitSharing.Api.zip"
            - $env:UI_ARTIFACT_NAME = "Demoulas.ProfitSharing.UI.QA.zip"
            - pwsh .\scripts\webDeploy.ps1 $env:ENV $env:API_SERVER_QA $env:API_ARTIFACT_NAME $env:UI_ARTIFACT_NAME

            - echo "Deploying background service..."            
            - pwsh .\scripts\servicesDeploy.ps1 ${env:ENV} $env:API_SERVER_QA
      - step: *upgrade-database
  
      - step:
          name: "Checking API Health"
          runs-on:
            - windows
            - self.hosted
          script:
            - $env:API_SERVER_QA = "appt23d"
            - pwsh -File ./scripts/Check-Health.ps1 -Url $env:QA_BASE_URL -envServerName $env:API_SERVER_QA

      - step:
          name: "Gate: Promote to UAT"
          runs-on:
            - windows
            - self.hosted
          trigger: "manual"
          script:
            - echo "Manual approval granted. Continuing to UAT deployment & data operations."
            - |
              Write-Host "Release context:"
              Write-Host ("  Build: " + $env:BITBUCKET_BUILD_NUMBER)
              Write-Host ("  Branch: " + $env:BITBUCKET_BRANCH)
              Write-Host ("  Commit: " + $env:BITBUCKET_COMMIT)
              Write-Host ("  QA API: " + $env:QA_BASE_URL)
              Write-Host "Artifacts in ./dist:"
              if (Test-Path .\dist) {
                Get-ChildItem -Recurse -File .\dist | ForEach-Object {
                  "{0,10} bytes  {1}" -f $_.Length, $_.FullName
                }
              } else {
                Write-Host "  (no dist folder found)"
              }
              Write-Host "Planned UAT sequence:"
              Write-Host "  1) Build DB CLI artifact"
              Write-Host "  2) Parallel: Drop & Recreate DB + Frontend build (UAT)"
              Write-Host "  3) Parallel: App deploy + Import from READY"
              Write-Host "  4) Import UAT navigation"
              Write-Host "  5) Parallel: Validate import + UAT API health check"

      - step: *db-cli-build-artifact
      - parallel:
          - step: *uat-drop-recreate-db
          - step: *create-frontend-artifact-uat
      - parallel:
          - step:
              name: "Application Deployment UAT"
              runs-on:
                - windows
                - self.hosted
              deployment: UAT
              script:
                - echo "Deploying application..."
                - $env:API_SERVER_UAT = "appt24d"
                - ${env:ENV} = "UAT"            

                - pwsh -File ./scripts/credsettings.ps1 `
                  -Environment ${env:ENV} `
                  -FilePath './src/services/configuration/credsettings.json' `
                  -OutputPath './src/services/configuration/credsettings.uat.json' `
                  -RemoteServer $env:API_SERVER_UAT `
                  -RemotePath 'C:/NextGenApplications/ps/EmployeeDelta'

                - pwsh -File ./scripts/credsettings.ps1 `
                  -Environment ${env:ENV} `
                  -FilePath './src/services/configuration/credsettings.json' `
                  -OutputPath './src/services/configuration/credsettings.uat.json' `
                  -RemoteServer $env:API_SERVER_UAT `
                  -RemotePath 'C:/NextGenApplications/ps/EmployeeFull'

                - pwsh -File ./scripts/credsettings.ps1 `
                  -Environment ${env:ENV} `
                  -FilePath './src/services/configuration/credsettings.json' `
                  -OutputPath './src/services/configuration/credsettings.uat.json' `
                  -RemoteServer $env:API_SERVER_UAT `
                  -RemotePath 'C:/NextGenApplications/ps/Payroll'

                - pwsh -File ./scripts/credsettings.ps1 `
                  -Environment ${env:ENV} `
                  -FilePath './src/services/configuration/credsettings.json' `
                  -OutputPath './src/services/configuration/credsettings.uat.json' `
                  -RemoteServer $env:API_SERVER_UAT `
                  -RemotePath 'C:/inetpub/wwwroot/api'

                - echo "Deploying web application..."
                - $env:API_ARTIFACT_NAME = "Demoulas.ProfitSharing.Api.zip"
                - $env:UI_ARTIFACT_NAME = "Demoulas.ProfitSharing.UI.UAT.zip"
                - pwsh .\scripts\webDeploy.ps1 $env:ENV $env:API_SERVER_UAT $env:API_ARTIFACT_NAME $env:UI_ARTIFACT_NAME

                - echo "Deploying background service..."            
                - pwsh .\scripts\servicesDeploy.ps1 ${env:ENV} $env:API_SERVER_UAT
          - step: *uat-import-from-ready
      - step: *uat-import-uat-navigation
      - parallel:
          - step: *uat-validate-import
          - step:
              name: "Checking API Health (UAT)"
              runs-on:
                - windows
                - self.hosted
              script:
                - $env:API_SERVER_UAT = "appt24d"
                - pwsh -File ./scripts/Check-Health.ps1 -Url $env:UAT_BASE_URL -envServerName $env:API_SERVER_UAT


    develop:
      - parallel:
          - step: *build-and-test-backend
          - step: *audit-frontend
          - step: *audit-backend


  pull-requests:
    '**':
      - parallel:
          - step: *build-and-test-backend
          - step: *audit-frontend
          - step: *audit-backend
          - step: *secret-scan
  
  custom:
    profitsharing_database:
      - variables: # https://bitbucket.org/blog/predefine-values-of-custom-pipeline-variables
          - name: Environment
            default: QA
            allowed-values:
              - QA
              - UAT
          - name: Action
            default: upgrade-db
            allowed-values:
              - upgrade-db
              - drop-recreate-db
              - import-from-ready
              - import-uat-navigation
              - generate-upgrade-script
              - validate-import
          - name: SourceSchema
            default: PROFITSHARE
            allowed-values:
              - PROFITSHARE
              - MTPR    
              - PROFITSHARE_STAGING
      - step:
          name: Validate SourceSchema
          script:
            - |
              if [ "$BITBUCKET_PIPELINE_OS" = "windows" ]; then
                pwsh -Command "
                  \$validSchemas = @{
                      'QA'  = @('PROFITSHARE', 'MTPR')
                      'UAT' = @('PROFITSHARE_STAGING')
                  }

                  if (-not \$validSchemas[\$env:Environment] -contains \$env:SourceSchema) {
                      Write-Host 'ERROR: Invalid SourceSchema for selected Environment'
                      Write-Host ('Allowed values for ' + \$env:Environment + ': ' + (\$validSchemas[\$env:Environment] -join ', '))
                      exit 1
                  }

                  Write-Host ('Validated: Environment=' + \$env:Environment + ', SourceSchema=' + \$env:SourceSchema)
                "
              else
                validSchemas_QA=("PROFITSHARE" "MTPR")
                validSchemas_UAT=("PROFITSHARE_STAGING")

                if [ "$Environment" = "QA" ]; then
                  validSchemas=("${validSchemas_QA[@]}")
                elif [ "$Environment" = "UAT" ]; then
                  validSchemas=("${validSchemas_UAT[@]}")
                else
                  echo "ERROR: Unknown Environment '$Environment'"
                  exit 1
                fi

                if [[ ! " ${validSchemas[@]} " =~ " $SourceSchema " ]]; then
                  echo "ERROR: Invalid SourceSchema '$SourceSchema' for Environment '$Environment'"
                  echo "Allowed values: ${validSchemas[*]}"
                  exit 1
                fi

                echo "Validated: Environment=$Environment, SourceSchema=$SourceSchema"
              fi
      - step: *upgrade-database
    playwright_e2e_qa:
      - step: *run-playwright-tests




