#!/bin/bash

# Pre-push hook: Run lint, test, and tsc if UI files changed
#                Run build and selective tests if backend files changed

echo ""
echo "========================================"
echo "üöÄ Pre-push hook starting..."
echo "========================================"

# Determine what to compare against:
# 1. If upstream exists, compare against it
# 2. Otherwise, compare against origin/develop (main branch)
if git rev-parse --verify @{u} >/dev/null 2>&1; then
    compare_ref="@{u}"
else
    compare_ref="origin/develop"
fi

echo "Comparing against: $compare_ref"
echo ""

# Get changed UI source files (only lintable extensions)
changed_ui_files=$(git diff --name-only "$compare_ref"..HEAD 2>/dev/null | grep '^src/ui/src/' | grep -E '\.(ts|tsx|js|jsx)$')

# Check if any files in src/ui/src have changed compared to the reference
if [ -n "$changed_ui_files" ]; then
    echo "üîç UI files changed - running checks..."

    cd src/ui || exit 1

    # Convert paths from repo root to relative to src/ui for ESLint
    lint_files=$(echo "$changed_ui_files" | sed 's|^src/ui/||')

    echo ""
    echo "üìã Running lint on $(echo "$lint_files" | wc -l | tr -d ' ') changed file(s)..."
    if ! npx eslint $lint_files; then
        echo "‚ùå Lint failed! Push aborted."
        exit 1
    fi

    echo ""
    echo "üß™ Finding tests related to changed files..."

    # Build list of test directories/patterns to run based on changed files
    test_patterns=""

    # Check each major area and add to test patterns if files changed there
    if echo "$changed_ui_files" | grep -q '^src/ui/src/utils/'; then
        test_patterns="$test_patterns src/utils"
    fi

    if echo "$changed_ui_files" | grep -q '^src/ui/src/hooks/'; then
        test_patterns="$test_patterns src/hooks"
    fi

    if echo "$changed_ui_files" | grep -q '^src/ui/src/components/'; then
        test_patterns="$test_patterns src/components"
    fi

    if echo "$changed_ui_files" | grep -q '^src/ui/src/reduxstore/'; then
        test_patterns="$test_patterns src/reduxstore"
    fi

    # Check each page area
    if echo "$changed_ui_files" | grep -q '^src/ui/src/pages/DecemberActivities/'; then
        test_patterns="$test_patterns src/pages/DecemberActivities"
    fi

    if echo "$changed_ui_files" | grep -q '^src/ui/src/pages/FiscalClose/'; then
        test_patterns="$test_patterns src/pages/FiscalClose"
    fi

    if echo "$changed_ui_files" | grep -q '^src/ui/src/pages/Beneficiaries/'; then
        test_patterns="$test_patterns src/pages/Beneficiaries"
    fi

    if echo "$changed_ui_files" | grep -q '^src/ui/src/pages/InquiriesAndAdjustments/'; then
        test_patterns="$test_patterns src/pages/InquiriesAndAdjustments"
    fi

    if echo "$changed_ui_files" | grep -q '^src/ui/src/pages/Reports/'; then
        test_patterns="$test_patterns src/pages/Reports"
    fi

    if echo "$changed_ui_files" | grep -q '^src/ui/src/pages/Distributions/'; then
        test_patterns="$test_patterns src/pages/Distributions"
    fi

    # Trim leading whitespace
    test_patterns=$(echo "$test_patterns" | sed 's/^ *//')

    if [ -n "$test_patterns" ]; then
        echo "   Running tests for: $test_patterns"
        if ! npm run test -- --run $test_patterns; then
            echo "‚ùå Tests failed! Push aborted."
            exit 1
        fi
    else
        echo "   No test areas matched changed files - skipping tests"
    fi

    echo ""
    echo "üìù Running TypeScript check..."
    if ! npx tsc -b --noEmit; then
        echo "‚ùå TypeScript check failed! Push aborted."
        exit 1
    fi

    echo ""
    echo "‚úÖ All UI checks passed!"
    cd - > /dev/null
else
    echo "‚ÑπÔ∏è  No UI files changed - skipping UI checks"
fi

# =============================================================================
# BACKEND CHECKS - Run if backend files changed
# =============================================================================

# Get changed backend files (specific extensions like pipeline)
changed_backend_files=$(git diff --name-only "$compare_ref"..HEAD 2>/dev/null | \
    grep '^src/services/' | \
    grep -E '\.(cs|csproj|sln|slnx|json|config)$' | \
    grep -v '/tests/')

if [ -n "$changed_backend_files" ]; then
    echo ""
    echo "üîç Backend files changed - running checks..."
    echo ""
    echo "Changed files:"
    echo "$changed_backend_files" | sed 's/^/   /'
    echo ""

    run_all_tests=false
    namespace_filters=""

    # Check for critical infrastructure files (same as pipeline)
    if echo "$changed_backend_files" | grep -qE '(Endpoints/Base/|Extensions/TelemetryExtensions|Common/Contracts/Result|Common/Contracts/Error|Data/Contexts/|Data/Migrations/)'; then
        echo "‚ö†Ô∏è  Critical infrastructure file changed - will run ALL tests"
        run_all_tests=true
    fi

    # Map files to namespace filters (only if not already running all)
    if [ "$run_all_tests" = false ]; then
        # Feature mappings (same as pipeline)
        if echo "$changed_backend_files" | grep -qE '(Endpoints/Beneficiaries/|Services/Beneficiaries/)'; then
            namespace_filters="$namespace_filters Beneficiaries"
        fi
        if echo "$changed_backend_files" | grep -qE '(Endpoints/Lookups/|Services/Lookup/)'; then
            namespace_filters="$namespace_filters Lookups"
        fi
        if echo "$changed_backend_files" | grep -qE 'Endpoints/Distributions/'; then
            namespace_filters="$namespace_filters Distributions"
        fi
        if echo "$changed_backend_files" | grep -qE 'Endpoints/Adjustments/'; then
            namespace_filters="$namespace_filters Adjustments"
        fi
        if echo "$changed_backend_files" | grep -qE '(Endpoints/YearEnd/|Services/YearEnd|Services/ProfitShareEdit)'; then
            namespace_filters="$namespace_filters YearEnd"
        fi
        if echo "$changed_backend_files" | grep -qE '(Endpoints/Military/|Services/Military/)'; then
            namespace_filters="$namespace_filters Military"
        fi
        if echo "$changed_backend_files" | grep -qE '(Endpoints/Validation/|Services/Validation/)'; then
            namespace_filters="$namespace_filters Validation"
        fi
        if echo "$changed_backend_files" | grep -qE '(Endpoints/ItOperations/|Services/ItDevOps/)'; then
            namespace_filters="$namespace_filters ItOperations"
        fi
        if echo "$changed_backend_files" | grep -qE '(Endpoints/Navigations/|Services/Navigations/)'; then
            namespace_filters="$namespace_filters Navigation"
        fi
        if echo "$changed_backend_files" | grep -qE '(Endpoints/BeneficiaryInquiry/|Services/BeneficiaryInquiry/)'; then
            namespace_filters="$namespace_filters BeneficiaryInquiry"
        fi
        if echo "$changed_backend_files" | grep -qE 'Endpoints/ProfitDetails/'; then
            namespace_filters="$namespace_filters ProfitDetails"
        fi
        if echo "$changed_backend_files" | grep -qE 'OracleHcm/'; then
            namespace_filters="$namespace_filters OracleHcm"
        fi
        if echo "$changed_backend_files" | grep -qE '(Services/Reports/|Endpoints/Reports/)'; then
            namespace_filters="$namespace_filters Reports"
        fi
        if echo "$changed_backend_files" | grep -qE 'Data/Entities/'; then
            namespace_filters="$namespace_filters Services"
        fi
        if echo "$changed_backend_files" | grep -qE 'Demoulas\.ProfitSharing\.Api/'; then
            namespace_filters="$namespace_filters Endpoints"
        fi
        if echo "$changed_backend_files" | grep -qE 'CachingServices/'; then
            namespace_filters="$namespace_filters Services"
        fi
        if echo "$changed_backend_files" | grep -qE 'Security/'; then
            namespace_filters="$namespace_filters Security"
        fi
        if echo "$changed_backend_files" | grep -qE 'Common/'; then
            namespace_filters="$namespace_filters Common"
        fi
        if echo "$changed_backend_files" | grep -qE 'Services/Pay/|Services/Total'; then
            namespace_filters="$namespace_filters Services"
        fi

        # Trim leading whitespace
        namespace_filters=$(echo "$namespace_filters" | sed 's/^ *//')

        # Check for unknown files (files that didn't match any pattern)
        for file in $changed_backend_files; do
            # Skip non-.cs files for unknown check (config files are ok)
            if ! echo "$file" | grep -qE '\.cs$'; then
                continue
            fi
            # Check if file matches any known pattern
            if ! echo "$file" | grep -qE '(Endpoints/Beneficiaries/|Services/Beneficiaries/|Endpoints/Lookups/|Services/Lookup/|Endpoints/Distributions/|Endpoints/Adjustments/|Endpoints/YearEnd/|Services/YearEnd|Services/ProfitShareEdit|Endpoints/Military/|Services/Military/|Endpoints/Validation/|Services/Validation/|Endpoints/ItOperations/|Services/ItDevOps/|Endpoints/Navigations/|Services/Navigations/|Endpoints/BeneficiaryInquiry/|Services/BeneficiaryInquiry/|Endpoints/ProfitDetails/|OracleHcm/|Services/Reports/|Endpoints/Reports/|Data/Entities/|Endpoints/Base/|Extensions/TelemetryExtensions|Common/Contracts/Result|Common/Contracts/Error|Data/Contexts/|Data/Migrations/|Demoulas\.ProfitSharing\.Api/|CachingServices/|Security/|Common/|Services/Pay/|Services/Total|Reporting/|Analyzers/)'; then
                echo "‚ö†Ô∏è  Unknown file pattern: $file - will run ALL tests"
                run_all_tests=true
                break
            fi
        done
    fi

    # Build the solution
    echo "üî® Building backend solution..."
    cd src/services || exit 1

    if ! dotnet build Demoulas.ProfitSharing.slnx --configuration Debug --verbosity quiet; then
        echo "‚ùå Backend build failed! Push aborted."
        exit 1
    fi

    # Determine test executable path
    test_exe="tests/Demoulas.ProfitSharing.UnitTests/bin/Debug/net10.0/Demoulas.ProfitSharing.UnitTests"

    # Check if test executable exists
    if [ ! -f "$test_exe" ]; then
        echo "‚ùå Test executable not found at: $test_exe"
        echo "   Try running: dotnet build Demoulas.ProfitSharing.slnx"
        exit 1
    fi

    echo ""
    if [ "$run_all_tests" = true ] || [ -z "$namespace_filters" ]; then
        echo "üß™ Running ALL backend unit tests..."
        if ! "$test_exe"; then
            echo "‚ùå Backend tests failed! Push aborted."
            cd - > /dev/null
            exit 1
        fi
    else
        echo "üß™ Running SELECTIVE backend tests for: $namespace_filters"
        # Build namespace args
        namespace_args=""
        for pattern in $namespace_filters; do
            namespace_args="$namespace_args -namespace *$pattern*"
        done
        echo "   Filter: $namespace_args"
        if ! "$test_exe" $namespace_args; then
            echo "‚ùå Backend tests failed! Push aborted."
            cd - > /dev/null
            exit 1
        fi
    fi

    cd - > /dev/null
    echo ""
    echo "‚úÖ All backend checks passed!"
else
    echo "‚ÑπÔ∏è  No backend files changed - skipping backend checks"
fi

echo ""
echo "========================================"
echo "‚úÖ Pre-push hook completed successfully"
echo "========================================"
echo ""
echo "‚è≥ Pushing to remote (this may take a moment)..."
echo ""

exit 0
