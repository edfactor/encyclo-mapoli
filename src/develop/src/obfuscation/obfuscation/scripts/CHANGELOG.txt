Obfuscation Framework

Version 8.4
------------
There were three additional fields in PROFDIST that needed to be 
deleted along with several others there that were already being 
removed.

To upgrade:

Reload functions_random.sql

Version 8.3
-------------
Improved reduction process by adding new script to target_master:
target_seed_all.sql. This will take any initial values in 
TARGET_BEN_SSN and add them to TARGET_SSN_ALL and also do the
same for TARGET_EMP_PSN and TARGET_BEN_PSN and add those to 
TARGET_ALL_PSN. The all tables are important, especially in 
orphan detection.

Slight improvement to PROFIT_SS_DETAIL orphan SSN detection.

Version 8.2
------------
Make the processing of PROFIT_SHARE comments more defensive.

In profit detail comments, notice and maintain the  >  or < character,
as they are both used.

In PROFIT_SS_DETAIL randomization of SSNNO fields (the unused external SSNs) 
rows for the same person will now have the same SSNs in almost all cases.

To upgrade, reload functions_random.sql

Version 8.1
--------------

The logic around detection and deletion of PSN orphans was changed 
significantly to accommodate not only duplicate orphan PSNS, but 
also multiple beneficiaries for a missing base badge number, which 
the previous code could not handle.

Orphan removal will no longer delete PAYREL SSNs that are not in  
DEMOGRAPHICS.

There are no upgrade tasks required.

Code comment improvements

Version 8.0
--------------
There is much better orphan detection and removal for PSNs

There is now a report that runs in the middle of obfuscation 
that shows orphan PSNs. It is check_psn_orphans.sql and it is 
in the obfuscate_master.sql scripts.

Comment changes and removal of some debug statements.

Corrected some logic around the processing of comments. Also, the < was 
changed to > for XFER and QDRO

To upgrade, reload:

-- functions_random.sql
-- functions_core.sql 

Run all these SQL statements:

DROP TABLE PAYPROFIT_PSN;
CREATE TABLE PAYPROFIT_PSN (PSN NUMBER(7));

CREATE TABLE PAYBEN_PSN_BASES (
    PSN NUMBER(11),
    PSN_BASE NUMBER(7)
);
CREATE INDEX PAYBEN_PSN_BASES_I ON PAYBEN_PSN_BASES ( PSN_BASE );

CREATE TABLE PROF_DIST_PSN_BASES (
    PSN NUMBER(11),
    PSN_BASE NUMBER(7)
);
CREATE INDEX PROF_DIST_PSN_BASES_I ON PROF_DIST_PSN_BASES ( PSN_BASE );

CREATE TABLE PYREL_PSN_BASES (
    PSN NUMBER(11),
    PSN_BASE NUMBER(7)
);
CREATE INDEX PYREL_PSN_BASES_I ON PYREL_PSN_BASES ( PSN_BASE );

 CREATE TABLE PROFIT_DETAIL_PSN_BASES (
    PSN NUMBER(11),
    PSN_BASE NUMBER(7)
);
CREATE INDEX PROFIT_DETAIL_PSN_BASES_I ON PROFIT_DETAIL_PSN_BASES ( PSN_BASE );

CREATE TABLE PROFIT_SS_DETAIL_PSN_BASES (
    PSN NUMBER(11),
    PSN_BASE NUMBER(7)
);
CREATE INDEX PROFIT_SS_DETAIL_PSN_BASES_I ON PROFIT_SS_DETAIL_PSN_BASES ( PSN_BASE );


Version 7.9
--------------
Embedded unknown numbers in PROFIT_DETAIL and PROFIT_SS_DETAIL in 
comment fields will either be replaced with a psn-style random 
number or a made up check number. These will be driven by new 
sequences. The idea is that these ranges will be more easily 
understood by someone looking at them as unknown PSNs or checks.

Those comment fields will also be padded to the maximum of 16 
characters by adding zeros to the full 11-digit length and adjusting 
the spacing of the prefix.

To upgrade, reload:
--functions_core.sql
--functions_random.sql

Execute these two statements: 
CREATE SEQUENCE CHECK_REPL START WITH 888000;
CREATE SEQUENCE PSN_RANDOM START WITH 9000000;

Version 7.8
-------------
To guard against padding of the PREFIX in the PROFIT_CMNT processing, 
use TRIM() function in employee and beneficiary PSN processing.

Any unknown numbers in PROFIT_CMNT and PROFIT_SS_CMNT in PROFIT_DETAIL 
and PROFIT_SS_DETAIL that are XFER and QDRO that were left unobfuscated 
will be deleted in the orphan detection process.

To upgrade:

You need to alter two tables:

ALTER TABLE PROFIT_SS_CMNT_PSN ADD DONE NUMBER(1) DEFAULT 0;
ALTER TABLE PROFIT_CMNT_PSN ADD DONE NUMBER(1) DEFAULT 0;

Reload:

-- functions_random.sql
-- functions_core.sql

Version 7.7

------------

Improvements in output logging and code comments.

PROCEDURE EXTRACT_COMMENT_PARTS now allows 1-digit badge numbers

To upgrade, reload:

-- functions_core.sql
-- functions_random.sql

Version 7.6
------------
Hardended the logic to extract PROFIT_CMNT fields so that unusual 
data does not cause issues.

To upgrade:

Reload functions_random.sql

Version 7.5
---------------
New name and address info in DEMOGRAPHICS should pull through to same fields 
in PROFIT_SS_DETAIL.

To upgrade:

Reload functions_core.sql

Version 7.4
----------------
The framework no longer removes several columns from PROFIT_SS_DETAIL. It will 
replace SSN, name, and address info, and leave the other columns alone.

It also applies the PROFIT_CMNT logic from PROFIT_DETAIL to PROFIT_SS_DETAIL.

Fix: PY_TERM will no longer be altered in DEMOGRAPHICS.

To upgrade:

You need to create table support for the PROFIT_SS_DETAIL PROFIT_SS_CMNT fix 
that is similar to the 7.3 upgrade.

CREATE TABLE PROFIT_SS_CMNT_PSN (
    PROFIT_SS_DET_RECNO NUMBER(9,0),
    PROFIT_SS_CMNT_PREFIX VARCHAR(16),
    PROFIT_SS_PSN NUMBER(11)
);

CREATE INDEX PROFIT_SS_CMNT_PSN_I ON PROFIT_SS_CMNT_PSN ( PROFIT_SS_PSN );

ALTER TABLE PSN_TASKS ADD PROFIT_SS_CMNT_PSN VARCHAR(1);

Then you need to reload:

- functions_fill_task_tables.sql
- functions_core.sql



Version 7.3
------------
Synthetic data now has more realistic PROFIT_DETAIL records that have 
PSNs in PROFIT_CMNT fields.

PROFIT_CMNT fields that contain PSNS, such as: XFER<1234567100
will not have the PSNs replaced with the newly obfuscated one that
was in DEMOGRAPHICS or PAYBEN.

To upgrade:

You need to reload the following function libraries:

- functions_random.sql
- functions_fill_task_tables.sql
- functions_core.sql

You also need to create a new table with these commands:

CREATE TABLE PROFIT_CMNT_PSN (
    PROFIT_DET_RECNO NUMBER(9,0),
    PROFIT_CMNT_PREFIX CHAR(16),
    PROFIT_PSN NUMBER(11)
);
CREATE INDEX PROFIT_CMNT_PSN_I ON PROFIT_CMNT_PSN ( PROFIT_PSN );

ALTER TABLE PSN_TASKS ADD PROFIT_CMNT_PSN VARCHAR(1);

Version 7.2
-------------
There is now a report you can run after reduction and after obfuscation.

To upgrade:

We need two new temporary tables for the report. 

Run these four sql statements:

CREATE TABLE EMP_AS_BEN_PSN (PSN NUMBER(11));
CREATE TABLE EMP_AS_BEN_SSN (SSN NUMBER(9));
CREATE INDEX EMP_AS_BEN_SSN_I on EMP_AS_BEN_SSN(SSN);
CREATE INDEX EMP_AS_BEN_PSN_I on EMP_AS_BEN_PSN(PSN);

Version 7.1
--------------
There were misalignments between the lengths of name, address and city fields between 
DEMOGRAPHICS and PAYBEN, and the corresponding fields in PROFDIST. This was causing 
a few updates with too-long DEMO values not to write, leaving those rows un-obfuscated.

In the target scripts, remove PAYREL and PAYBEN by SSN, not PSNs. Also, delete from 
PROFDIST and PROFIT_SS_DETAIL by TARGET_ALL_SSN table, not just TARGET_EMP_SSN table.

To upgrade:

Reload functions_core.sql

Version 7.0
------------
In PROFIT_SHARE_CHECKS a bug was fixed where PAYABLE_NAME only was obscured for
beneficiaries, but not employees.

To upgrade:

Reload functions_core.sql

Version 6.9
----------
Improved code documentation

Version 6.8
-----------
Adjust_date function for obfuscating dates now handles bad dates and returns zero.

To upgrade:
Reload functions_random.sql

Version 6.7
-------------
Fixed another bug where PAYBEN date of birth is in wrong format.

Version 6.6
---------------

Fixed bug where PAYBEN date of birth was often set to zero.

Fixed a bug where the pull through name and address values for PROFDIST 
might have been too long in rare cases.

Added a couple of hundred more first and last names to reduce number of 
first-last repeats. There will still be a few, but quite rare.

CHAR and VARCHAR fields will be set to spaces to the max length for the column.
This is now done via a new function that gets the length for the column and
table, rather than hardcoding error-prone text strings into these assignments.

The obfuscation_valiation.sql script now has queries to let you see how many
unique SSNs there were in TARGET_EMP_SSN, in the SSN_TASKS table, in 
DEMOGRAPHICS, and beneficiary counts. This should validate that all SSNs
made it all the way through the process.

When an employee is a beneficiary, these fields are now the same in both 
obfuscated records:
 PY_STATE, PY_ZIP, PY_DOB, PY_CITY, PY_ADD2, PY_ADD, PY_NAM

To 'remember' those fields from the employee obfuscation in obfuscate_employees
while going on to obfuscate_beneficiaries, a new database table was needed:
EMPLOYEES_OBFUSCATED

So a new setup script is there: 
create_employee_obf_table.sql

To upgrade: 
- Run the new script: create_employee_obf_table.sql
- Reload functions_random.sql
- Reload functions_core.sql

Version 6.5
------------
PAYREL now gets all 11 digits on PYREL_PSN, as required.

To upgrade:

Reload functions_core.sql

Version 6.4
-----------------
When employees were beneficiaries, the framework was obfuscating those rows
twice, disconnecting PAYREL, PAYBEN, PAYPROFIT, and PROFIT_DETAIL rows from the 
employee in DEMOGRAPHICS. This has been corrected. (see upgrade info below)

In DEMOGRAPHICS, PY_ASSIGN_DESC will be a space when blank, and not null

Getting a random date inside a year will return 0 if the incoming value is
either 0 or a number less than 1850 (which is certainly bad data).

Modified test suite (in test_bulk_data_create.sql) to give employees as 
beneficiaries PAYPROFIT and PROFIT_DETAIL rows to enable better testing 
of these scenarios

To upgrade:

Reload functions_core.sql

Version 6.3
------------
obfuscation_setup.sql has updated script names


Version 6.2
------------
Give most scripts better names

In the target scripts, PAYPROFITS are also searched for deletion
by PSNs in TARGET_ALL_PSN

Update: Despite name changes, there is nothing to reload or worry about.
If you are using the "master" driver scripts, nothing changes. Individual
scripts will have different names.

Version 6.1
-------------
More accurate PAYREL orphan detection.


Version 6.0
---------------
Code was added to make sure beneficiary name is never longer than the allowed 
40 characters.

In target_small_deletions.sql, the code that removed PAYREL records by SSN was
removed as they might not be in either DEMOGRAPHICS or PAYBEN.

Version 5.9
-------------
PAYREL PSNs can be either raw employee badge numbers or PAYBEN-style PSNs. Now the
reduction scripts take this into account. 

The test data in bulk_data_load.sql also has relatives who are employees and non-
employees.

To upgrade, you need to create a new target table and add an index:
CREATE TABLE TARGET_ALL_PSN (PSN NUMBER(11));
CREATE INDEX TARGET_ALL_PSN_I on TARGET_ALL_PSN(PSN);

Also, you need to drop and re-create the PYREL_PSN table and index:




Also, reload:
-load_random_functions.sql
-load_fill_temp_table_functions.sql
-load_obf_id_functions.sql

Version 5.8
--------------
There was a missing column name in target_small_deletions.sql. 

Version 5.7
-------------
The reduction script (target_small_deletions.sql) now deletes with the 
TARGET_ALL_SSN source and not TARGET_EMP_PSN, as that won't handle beneficiary rows.

Version 5.6
------------
-- For all DEMOGRAPHICS date columns, rather than creating all new ones, instead, the
years will be kept and the month and day will be randomly adjusted by small amounts
in order to preserve date-based calculations
-- Bulk loader now creates occational employees as beneficiaries with PAYPROFIT records for them
-- On DEMOGRAPHICS, PY_TERM flag is Y/N not 1/0
-- The target scripts that limit records no longer delete PROFIT_DETAIL records for beneficiary SSNs
-- When targeting PROFIT_SHARE_CHECKS for deletion, also delete checks where SSN_NUMBER (different from
EMPLOYEE_SSN) is not in either employee or beneficiary SSNs.
-- On PAYPROFIT, if the SSN is a beneficiary SSN, it gets picked up for replacement
by the obfuscated new beneficiary SSN, preventing that record from being erased
by the orphan process.

To upgrade, reload:
- load_fill_temp_table_functions.sql
- load_obf_id_functions.sql
- load_random_functions.sql

Version 5.5
-------------
-- Hire and rehire dates in DEMOGRAPHICS should be initialized to zero
-- If someone is terminated, the PY_TERM flag must be set to 1

To upgrade, reload load_random_functions.sql

Version 5.4
-------------
Corrections on DEMOGRAPHICS date adjustments


Version 5.3
--------------
-- In DEMOGRAPHICS, make PY_NAM First Name, Last Name
-- In DEMOGRAPHICS, PY_ADD and PY_CITY should be upper case
-- In DEMOGRAPHICS, all dates are now YYYYMMDD, except PWD_DT which 
is a field of type date.

-- In PYREL, the PSN is not employee badge + 4 digit code,
but merely the employee badge number

-- In PAYBEN, the full name is last, first
-- In PAYBEN, the date is YYYYMMDD
-- In PAYBEN, lowercase for PYBEN_ADD and PYBEN_CITY

-- In PROFDIST, the followign fields now use a space and not null 
when empty:
PROFDIST_3RDPAYTO, PROFDIST_3RDNAME, PROFDIST_3RDADDR1, PROFDIST_3RDADDR2, 
PROFDIST_3RDCITY, PROFDIST_3RDSTATE

Upgrade instructions:

-- As PYREL's PSN is now 7 digits and not 11, you will have to
drop PYREL_PSN and re-run the create line on Line 28 of
create_index_tables.sql:
DROP TABLE PYREL_PSN;
CREATE TABLE PYREL_PSN (PSN NUMBER(7));

-- You should also drop the index for this and re-run the index 
creation on Line 53:
DROP INDEX PYREL_PSN_I;
CREATE INDEX PYREL_PSN_I ON PYREL_PSN ( PSN );

-- You need to reload load_obf_id_functions.sql
-- You need to reload load_random_functions.sql
-- You need to reload load_fill_temp_tables.sql

Version 5.2
---------------
Add PAYREL to the obfuscation detection
Obscure PAYREL SSNs, not just PSNs

Upgrade instructions: you must reload load_obf_id_functions.sql

Version 5.1
----------------
Added five fields to the DEMOGRAPHICS table:

PY_SHOUR
PY_SET_PWD
PY_SET_PWD_DT
PY_CLASS_DT
PY_GUID

The changes are in two places: obfuscate_employees.sql and load_random_functions.sql.

The second file (load_random) must be reloaded to update an SQL type and two functions there.

Version 5.0
-------------
Add SOC_SEC_REC to reduction script.

Note: to upgrade to this, you need to create the TARGET_ALL_SSN table.
Execute these two SQL statements:
CREATE TABLE TARGET_ALL_SSN (SSN NUMBER(9));
CREATE INDEX TARGET_ALL_SSN_I on TARGET_ALL_SSN(SSN);

Version 4.9
--------------
Improve orphan handling of SOC_SEC_REC

Version 4.8
------------
Fix typo in fill_store_tables.sql

Provide support for new table, SOC_SEC_REC. If you have already installed the
framework, you need to follow these instructions:

First, DROP SSN_TASKS
This is because this table changed. Then execute the create table SSN_TASKS statement
that is in create_temp_id_tables.sql on line 38.

Next, in create_indexes.sql, execute lines 42, 43.
Then, in create_index_tables.sql, execute lines 21, 46.

Then you need to reload two function libraries:
load_fill_temp_table_functions.sql
load_obf_id_functions.sql

After this setup, you can execute obfuscation normally from now on.

Version 4.7
-----------
Allow either low or high number of stores for big stores calculation.

Version 4.6
-------------
Do not assume there are at least 3 stores among employees.

Version 4.5
--------------
Refactor deletion scripts into two: one for PAY9 tables, one for working temp tables for the framework.

Add PROFIT_SS_DETAILS to the target deletion scripts.

Version 4.4
--------------
Add PROFIT_SS_DETAILS to orphan test data and deletion.

Version 4.3
----------------
Add PROFIT_SS_DETAILS table to the framework. 

Note: if upgrading from a previous version, you must do this:

DROP SSN_TASKS;
Re-run just the CREATE SSN_TASKS sql command inside create_temp_id_tables.sql

CREATE TABLE PROFIT_SS_DETAIL_SSN (SSN NUMBER(9));
CREATE INDEX PROFIT_SS_DETAIL_SSN_I ON PROFIT_SS_DETAIL_SSN ( SSN );

re-run these three setup scripts:

load_fill_temp_table_functions.sql
load_obf_id_functions.sql
load_random_functions.

Then you can go back to just running obfuscate_master.sql as usual.

Version 4.2
---------------------
Remove secondary SSN orphan checking for PAYPROFIT, PROFIT_SHARE_CHECKS, and PROFDIST

Version 4.1
---------------
New patterns to drastically reduce time of target bulk deletions.

Version 4.0
----------------
Small fixes, refactoring, and performance improvements for bulk deletes.

Version 3.9
--------------
There are now four additional sql files that will let you remove all but a subset of
employees (and all related beneficiaries and records) for obfuscation. This is 
explained in the documentation.

Version 3.8
-------------
Remove audit table handling and sample data


Version 3.7
--------------
In post validation, null values should not count as unobfuscated rows.

Version 3.6
------------

There is a a new post validation script that can be run to see if all
SSN and PSN values were obfuscated. It prints out a report. 

The starting sequence number for PSNs was reduced to 700000, to allow
more room for large obfuscations.

Version 3.5
------------
Features:
There is now a script that can run at the end that will remove
any records that have been orphaned from the DEMOGRAPHICS
or PAYBEN table. An example of this is that someone changed 
their SSN. 

Fixes:
- Sample data in create_test_data.sql was fixed to have proper 
relationships.
- Employee id fields were incorrectly being removed from PROFDIST
instead of PROFIT_SHARE_CHECKS, where the field is too narrow.
- NULLs were being collected into the lookup tables for SSNs and
PSNs.

Documentation:
Orphan removal explained.