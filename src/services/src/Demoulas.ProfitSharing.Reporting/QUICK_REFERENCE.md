# PDF Report Generation - Quick Reference

Fast reference for creating new PDF reports using the Profit Sharing Reporting module.

## TL;DR - 5 Minute Setup

### Step 1: Create Your Report Class

```csharp
using Demoulas.ProfitSharing.Reporting.Core;
using QuestPDF.Fluent;

public class YearEndStatementReport : BasePdfReport
{
    public override string Title => "Year End Profit Sharing Statement";
    public override string ReportName => "year-end-statement";

    protected override void ComposeHeader(IContainer header)
    {
        header.ComposeStandardHeader("Year End Profit Sharing Statement", showLogo: true);
    }

    protected override void ComposeContent(IContainer content)
    {
        content.Column(column =>
        {
            column.Item().Text("Your report content here");
        });
    }
}
```

### Step 2: Use in Your Endpoint

```csharp
public class YearEndStatementEndpoint : Endpoint<YearEndRequest, Results<Ok<byte[]>, NotFound>>
{
    private readonly PdfReportGenerator _pdfGenerator;
    private readonly IMyDataService _dataService;

    public override async Task HandleAsync(YearEndRequest req, CancellationToken ct)
    {
        // Get your data
        var data = await _dataService.GetDataAsync(req.Year, ct);

        // Create report
        var report = new YearEndStatementReport(data);

        // Generate PDF
        byte[] pdf = await _pdfGenerator.GeneratePdfAsync(report, ct);

        // Return
        return Results.Ok(pdf);
    }
}
```

### Step 3: Return to Client

The byte[] can be returned as:

**From HTTP Endpoint:**

```csharp
// FastEndpoints will auto-handle byte[] as application/octet-stream
return Results.Ok(pdf);

// Or with content disposition for file download
HttpContext.Response.Headers.Add("Content-Disposition", "attachment; filename=report.pdf");
return Results.File(pdf, "application/pdf");
```

**Or saved to disk:**

```csharp
await _pdfGenerator.SavePdfAsync(report, "/path/to/file.pdf", ct);
```

---

## Common Elements

### Section Header

```csharp
column.Item().ComposeSectionHeader("My Section Title");
```

### Key-Value Pair

```csharp
column.Item().ComposeKeyValuePair("Label", "Value");
column.Item().ComposeKeyValuePair("Amount", "$1,234.56", bold: true);
```

### Table

```csharp
column.Item().ComposeTableHeaderRow("Column A", "Column B", "Column C");

bool alternate = false;
foreach (var item in items)
{
    column.Item().ComposeTableDataRow(alternate, item.Col1, item.Col2, item.Col3);
    alternate = !alternate;
}

column.Item().ComposeTotalsRow("TOTAL", "$5,000.00");
```

### Divider

```csharp
column.Item().ComposeDivider();
```

### Section Break (vertical space)

```csharp
column.Item().ComposeSectionBreak();
```

### Currency Formatting

```csharp
decimal amount = 1234.56m;
string formatted = amount.ToCurrencyString();           // "$1,234.56"
string nullable = ((decimal?)null).ToCurrencyStringOrEmpty();  // "-"
```

### Text Truncation

```csharp
string truncated = "Very long text here".TruncateWithEllipsis(15);  // "Very long te..."
```

---

## Standard Styling

All styling is automatic via `PdfReportConfiguration`:

| Item         | Value        |
| ------------ | ------------ |
| Brand Blue   | #0033AA      |
| Header Gray  | #F0F0F0      |
| Totals Gray  | #E8E8E8      |
| Title Font   | 14pt Bold    |
| Header Font  | 12pt Bold    |
| Content Font | 10pt Regular |
| Footer Font  | 8pt Regular  |

---

## Customization

### Hide Page Numbers

```csharp
public override bool IncludePageNumbers => false;
```

### Hide Footer

```csharp
public override bool IncludeCompanyFooter => false;
```

### Custom Footer

```csharp
protected override void ComposeFooter(IContainer footer)
{
    footer.Text("My custom footer text");
}
```

### Custom Header (each page)

```csharp
protected override void ComposeHeader(IContainer header)
{
    header.Row(row =>
    {
        row.RelativeColumn().Text("Custom Header");
        row.RelativeColumn().AlignRight().Text("Right Aligned");
    });
}
```

### Custom Generated By

```csharp
public override string GeneratedBy => "Year-End Batch Job";
```

---

## Testing Your Report

```csharp
[Fact]
public void MyReport_GeneratesPdf()
{
    // Arrange
    var report = new MyReport();

    // Act
    byte[] pdf = report.GeneratePdf();

    // Assert
    Assert.NotNull(pdf);
    Assert.True(pdf.Length > 0);

    // Optional: Save to disk for manual inspection
    File.WriteAllBytes("test-output.pdf", pdf);
}
```

---

## QuestPDF Fluent API Basics

For more complex layouts, use QuestPDF directly:

```csharp
protected override void ComposeContent(IContainer content)
{
    content.Column(column =>
    {
        // Single element
        column.Item().Text("Hello World");

        // Sized element
        column.Item().Height(100).Background("#CCCCCC");

        // Row (horizontal layout)
        column.Item().Row(row =>
        {
            row.RelativeColumn().Text("Left");
            row.RelativeColumn().AlignRight().Text("Right");
        });

        // Conditional
        if (condition)
        {
            column.Item().Text("Conditional text");
        }

        // Loop
        foreach (var item in items)
        {
            column.Item().Text(item.Name);
        }

        // Page break
        column.Item().PageBreak();
    });
}
```

For full QuestPDF API, see: https://www.questpdf.com/getting-started.html

---

## Troubleshooting

| Issue                 | Solution                                                            |
| --------------------- | ------------------------------------------------------------------- |
| Logo not showing      | Ensure `mb_mfyd.png` is in `Resources/` folder as embedded resource |
| Text overflows        | Use `.TruncateWithEllipsis(maxLength)` for long text                |
| Large reports slow    | PDF generation is sync; consider async wrapper                      |
| Formatting wrong      | Check `PdfReportConfiguration` for color/font overrides             |
| Content not appearing | Verify inside `ComposeContent()`, not `ComposeHeader()`             |
| Page numbers missing  | Set `public override bool IncludePageNumbers => true;`              |

---

## File Locations

-   **Core Classes**: `Demoulas.ProfitSharing.Reporting/Core/`
-   **Example**: `Demoulas.ProfitSharing.Reporting/Examples/SampleProfitSharingReport.cs`
-   **Configuration**: `PdfReportConfiguration.cs`
-   **Utilities**: `PdfUtilities.cs`
-   **Logo**: `Demoulas.ProfitSharing.Reporting/Resources/mb_mfyd.png`

---

## Dependencies

Required (auto-resolved):

-   QuestPDF (via Directory.Packages.props)

Optional:

-   None - this module is self-contained

---

## Related Patterns

**Telemetry:** Add telemetry calls when generating reports

```csharp
EndpointTelemetry.BusinessOperationsTotal.Add(1,
    new("operation", "year-end-report-generation"),
    new("report_type", "profit-sharing-statement"));
```

**Error Handling:** Use `Result<T>` pattern

```csharp
return Result<byte[]>.Success(pdf);
```

**Validation:** Validate inputs before generating

```csharp
if (year < 2000 || year > DateTime.Now.Year)
    return Result<byte[]>.Failure(Error.InvalidYear);
```

---

## Next Steps

1. Create your report class inheriting `BasePdfReport`
2. Implement `ComposeContent()` with your data/layout
3. Inject `PdfReportGenerator` in endpoint
4. Call `_pdfGenerator.GeneratePdfAsync(report, ct)`
5. Return PDF bytes to client

See `README.md` for comprehensive documentation.
