# Build Information Separation Strategy

**Date**: October 7, 2025  
**Objective**: Enable cloud migration of UI build steps by separating .NET tool dependency

## Problem Statement

Current UI artifact build steps (`create-frontend-artifact-qa/uat/prod`) cannot move to cloud runners because they depend on:
1. **Demoulas.Common.Build.Cli** - A .NET global tool (requires .NET SDK)
2. This tool generates `.buildinfo.json` with build metadata
3. Windows PowerShell for artifact compression

## Solution: Artifact-Based Separation

### Architecture Change

**Before** (All on Windows):
```
create-frontend-artifact-qa:
  ├─ dotnet tool install (Windows, .NET SDK)
  ├─ generate .buildinfo.json
  ├─ npm ci
  ├─ npm run build:qa
  └─ Compress-Archive (PowerShell)
```

**After** (Split Windows/Cloud):
```
Stage 1 (Windows):
  generate-buildinfo:
    └─ dotnet tool → .buildinfo.json [artifact]

Stage 2 (Cloud - Parallel):
  create-frontend-artifact-qa:
    ├─ download .buildinfo.json [artifact]
    ├─ npm ci
    ├─ npm run build:qa
    └─ zip (Linux)
```

### Key Innovation

**Bitbucket Pipelines Artifact System**:
- Artifacts from previous stages are automatically available to later stages
- No manual download needed - just reference the file
- Works across Windows/Linux boundaries

## Resource Impact

### Windows Runners Freed

**Per Release Pipeline**:
- **Before**: 3 Windows runners (QA + UAT + PROD sequential, ~30-45 min total)
- **After**: 1 Windows runner (buildinfo only, ~30 seconds)
- **Savings**: 2-3 Windows runners, 29-44 minutes

### Cloud Minutes Used

**Per Release Pipeline**:
- generate-buildinfo: ~0.5 minutes (Windows - not counted in cloud budget)
- create-frontend-artifact-qa: ~5-7 minutes (Cloud)
- create-frontend-artifact-uat: ~5-7 minutes (Cloud, parallel)
- create-frontend-artifact-prod: ~5-7 minutes (Cloud, parallel)
- **Total cloud time**: ~15-21 minutes (but runs in parallel, so ~5-7 min wall time)

### Monthly Impact

**Estimated Usage** (40 PRs + 10 releases):
- Current cloud usage: ~320 minutes/month (PRs only)
- Additional from UI builds: 10 releases × 15 min = 150 minutes
- **New total: ~470 minutes/month** (still under 500 free tier!)

**Even if over free tier**:
- Cost: ~$1-2/month for 20-50 extra minutes
- Benefit: Frees 20-30 Windows runner hours/month
- ROI: Massive (on-premises infrastructure >> cloud minutes cost)

## Implementation Benefits

### 1. Parallel Execution
- QA, UAT, PROD builds run simultaneously
- Total wall time: ~5-7 minutes instead of 30-45 minutes
- **6-9x faster** for UI artifact creation

### 2. Resource Optimization
- Single buildinfo generation reused 3 times
- Consistent build metadata across all environments
- Reduced on-premises infrastructure load

### 3. Scalability
- Cloud resources scale better than on-premises
- Can handle traffic spikes without resource contention
- Predictable performance

### 4. Maintainability
- Cleaner separation of concerns
- Easier to troubleshoot (build vs metadata generation)
- Consistent patterns across environments

## Technical Details

### buildinfo.json Structure

Generated by `Demoulas.Common.Build.Cli`:
```json
{
  "buildId": "12345",
  "branch": "develop",
  "commitHash": "abc123def456",
  "buildDate": "2025-10-07T10:30:00Z",
  "version": "1.0.0"
}
```

Used by frontend at runtime to display build information.

### Artifact Flow

1. **Stage 1**: Windows runner generates `.buildinfo.json` at repo root
2. **Bitbucket**: Uploads artifact to pipeline storage
3. **Stage 2**: Cloud runners download artifact (automatic)
4. **Cloud steps**: Copy `.buildinfo.json` to `src/ui/public/` before build
5. **Vite**: Bundles file into production build
6. **Output**: Artifact includes buildinfo.json in dist

### Archive Compatibility

**Windows**: `Compress-Archive` → `.zip` (Microsoft format)  
**Linux**: `zip -r` → `.zip` (standard format)

Both produce compatible ZIP archives that:
- Extract correctly with PowerShell `Expand-Archive`
- Work with Windows deployment scripts
- Maintain file permissions and structure

## Risk Assessment

### Very Low Risk
- ✅ Pure refactor - no logic changes
- ✅ Standard archive format (zip)
- ✅ Well-tested artifact system (Bitbucket built-in)
- ✅ Can test in isolation (single environment first)

### Potential Issues & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Artifact not found | Low | High | Add explicit check + error message |
| Archive incompatible | Very Low | Medium | Test deployment before rollout |
| Cloud minutes exceed budget | Medium | Low | Monitor usage, still cheap vs on-premises |
| Performance slower | Very Low | Low | Cloud often faster than old on-premises |

## Testing Strategy

### Phase 1: Single Environment Test
1. Implement generate-buildinfo step
2. Convert only QA artifact to cloud
3. Test complete release to QA environment
4. Verify artifact structure matches expectations
5. Validate deployment works unchanged

### Phase 2: Full Rollout
1. Convert UAT and PROD artifacts
2. Enable parallel execution
3. Monitor cloud minutes usage
4. Validate Windows runner usage drops

### Validation Checklist
- [ ] .buildinfo.json present in artifacts
- [ ] File copied to public/ directory
- [ ] Vite includes file in production build
- [ ] ZIP archive structure correct
- [ ] Deployment scripts work unchanged
- [ ] Build metadata visible in UI
- [ ] Parallel builds complete successfully
- [ ] Cloud minutes within budget
- [ ] Windows runner usage decreased

## Rollback Plan

### If Issues Occur

**Option 1**: Revert specific step
```yaml
# Comment out cloud version
# - step: *create-frontend-artifact-qa

# Restore Windows version (keep commented in pipeline)
- step: *create-frontend-artifact-qa-windows
```

**Option 2**: Full revert
```bash
git revert <commit-hash>
git push
```

### No Deployment Changes Required
- Deployment scripts don't change
- Artifact format identical
- Can switch back/forth without downtime

## Future Enhancements

### Potential Improvements
1. **Cache node_modules** - Could save ~2-3 min per build (if Bitbucket adds caching)
2. **Consolidate steps** - Single parameterized step for all environments
3. **Move more to cloud** - Investigate backend build feasibility
4. **Optimize buildinfo** - Could generate in parallel with other builds

### Opportunities
- Apply same pattern to other .NET tools
- Use for documentation generation
- Enable cloud-first development workflow

## Recommendation

✅ **STRONGLY RECOMMENDED**

This change provides massive ROI:
- **6-9x faster** UI artifact creation
- **Frees 2-3 Windows runners** per release
- **Minimal risk** - pure refactor
- **Cost-effective** - ~$1-2/month vs freeing expensive on-premises resources
- **Enables parallel builds** - future scalability

**Implementation effort**: ~2-4 hours  
**Value delivered**: Immediate and sustained improvements

---

**Next Action**: Review UI_CLOUD_MIGRATION_ANALYSIS.md for complete implementation code
